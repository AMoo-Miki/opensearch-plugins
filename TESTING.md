<!-- TOC -->
- [Testing](#testing)
  - [Code Coverage Collecting](#code-coverage-collecting)
    - [OpenSearch plugin](#opensearch-plugin)
      - [Gradle project](#gradle-project)
      - [Maven project](#maven-project)
      - [Limitation](#limitation)
    - [OpenSearch Dashboards plugin](#opensearch-dashboards-plugin)
  - [Code Coverage Reporting](#code-coverage-reporting)
    - [Code coverage report upload through CI workflow](#code-coverage-report-upload-through-ci-workflow)
    - [A status badge in README file to show the code coverage](#a-status-badge-in-readme-file-to-show-the-code-coverage)
    - [Codecov integration in Pull Requests](#codecov-integration-in-pull-requests)
<!-- TOC -->

## Testing

### Code Coverage Collecting
Code coverage is a measurement of how many lines of code are executed under the test suites.

#### OpenSearch plugin
It is recommended to use [JaCoCo](https://www.eclemma.org/jacoco/) library to generate the code coverage report. The following guide may help you use JaCoCo in OpenSearch plugins with ease.
##### Gradle project
1. Add [JaCoCo Gradle plugin](https://docs.gradle.org/current/userguide/jacoco_plugin.html) to `build.gradle` in your repository. [example](https://github.com/opensearch-project/sql/blob/opensearch-1.0.0.0-rc1/build.gradle#L48)
2. Set Jacoco to export coverage report in `xml` format. [example](https://github.com/opensearch-project/sql/blob/opensearch-1.0.0.0-rc1/build.gradle#L101-L105)
3. Call gradle task "jacocoTestReport" to generate report (`./gradlew jacocoTestReport`) after running your tests. (Or add a `dependsOn` to make "jacocoTestReport" task depending on your test tasks. [example](https://github.com/opensearch-project/index-management/blob/opensearch-1.0.0.0-beta1/build-tools/coverage.gradle))

##### Maven project
Since OpenSearch uses Gradle as the build tool, we don't recommend using Maven.
Code coverage for a Maven project can be generated by [JaCoCo Maven plugin](https://www.eclemma.org/jacoco/trunk/doc/maven.html), and here is an [example](https://github.com/opensearch-project/security/blob/v1.0.0.0-rc1/pom.xml#L636).

##### Limitation
1. JaCoCo Gradle plugin can not collect code coverage properly for integration tests (tests that extend `OpenSearchIntegTestCase` or `OpenSearchRestTestCase`, see [here](https://github.com/opensearch-project/OpenSearch/blob/1.0/TESTING.md#base-classes-for-test-cases) to learn more). However, there is a workaround to collect coverage when the integration test is running on a local single node cluster. For your reference, [this file](https://github.com/opensearch-project/index-management/blob/opensearch-1.0.0.0-beta1/build-tools/coverage.gradle) is a custom Gradle plugin to help achieve, and it can be applied conditionally like [here](https://github.com/opensearch-project/index-management/blob/opensearch-1.0.0.0-beta1/build.gradle#L90-L93).
2. Additional work is needed to get coverage report by JaCoCo for the test classes which use [PowerMock](https://github.com/powermock/powermock), because those classes must be instrumented before the test executes. Please see the [PowerMock wiki](https://github.com/powermock/powermock/wiki/Code-coverage-with-JaCoCo) for detail, and there is an example for using JaCoCo Maven plugin. But for JaCoCo Gradle plugin, there is no native support, see the [issue](https://github.com/gradle/gradle/issues/2429) in `gradle` repository for detail.
3. JaCoCo Gradle plugin can not merge code coverage reports from different sub-projects out-of-box, when the code repository contains a [Gradle multi-project build](https://docs.gradle.org/6.6.1/userguide/multi_project_builds.html). If you need the aggrectiated code coverage report from multiple sub-projects, please check the [example](https://github.com/opensearch-project/alerting/blob/opensearch-1.0.0.0-beta1/build-tools/merged-coverage.gradle) of a custom Gradle plugin in OpenSearch Alerting plugin, or the [sample](https://docs.gradle.org/6.6.1/samples/sample_jvm_multi_project_with_code_coverage.html) from Gradle.

#### OpenSearch Dashboards plugin
OpenSearch Dashboards mainly uses [Jest](https://jestjs.io/) for unit testing, and plugins are recommended to utilize Jest as the unit testing framework.

To generate code coverage report under Jest framework, adding the flag `--coverage` in the command to run unit tests. See [here](https://github.com/opensearch-project/security-dashboards-plugin/blob/opensearch-1.0.0.0-beta1/.github/workflows/unit-test.yml#L67) for an example in the CI workflow.

### Code Coverage Reporting
OpenSearch plugins are using [Codecov](https://about.codecov.io/) for code coverage reporting and analysis. The dashboard can be seen [here](https://app.codecov.io/gh/opensearch-project/).

All the OpenSearch plugins are required to have the following items:

#### Code coverage report upload through CI workflow
1. Generate code coverage report in `xml` format in a CI workflow of Github Actions
2. Upload the report to Codecov by adding a step of [codecov-action](https://github.com/codecov/codecov-action) in the workflow.
3. For private repositories, an upload token is needed, visit the repository page of Codecov to get your token: https://codecov.io/gh/opensearch-project/REPO-NAME-HERE. Please follow [Github docs](https://docs.github.com/en/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository) to use Github Secrets to store the token and not expose to the public.
4. Set the workflow to be triggered by `push` and `pull request` on `main` and release branches.
5. To see your code coverage results from Codecov, visiting https://codecov.io/gh/opensearch-project/REPO-NAME-HERE after the CI workflow is triggered.

See [CI Workflows](STANDARDS.md#ci-workflows) for example.

#### A status badge in README file to show the code coverage
See [here](https://github.com/opensearch-project/index-management/blob/main/README.md) for an example of the status badge.

Add the following line at the header of the README markdown file of the repository:
```
[![codecov](https://codecov.io/gh/opensearch-project/REPO-NAME-HERE/branch/main/graph/badge.svg)](https://codecov.io/gh/opensearch-project/REPO-NAME-HERE)
```
Link of the badge can also be accessed from the repository's settings page of Codecov: 
https://app.codecov.io/gh/opensearch-project/REPO-NAME-HERE/settings/badge

#### Codecov integration in Pull Requests
1. Add a `codecov.yml` file into the repository ([example](https://github.com/opensearch-project/k-NN/commit/f7d1985230ce851cb97a7e41d8bce32127a4f33b))
2. Set the target code coverage properly in case it blocks your PR in Github checks.

See Codecov docs to learn more about [codecov yaml file](https://docs.codecov.com/docs/codecov-yaml) and [common configurations](https://docs.codecov.com/docs/common-recipe-list).