<!-- TOC -->
- [Testing](#testing)
    - [Code Coverage Collecting](#code-coverage-collecting)
    - [Code Coverage Reporting](#code-coverage-reporting)
<!-- TOC -->

## Testing

### Code Coverage Collecting
Code coverage is a measurement of how many lines of code are executed under the test suites.

#### OpenSearch plugin

##### Gradle project
1. Add [JaCoCo Gradle plugin](https://docs.gradle.org/current/userguide/jacoco_plugin.html) to `build.gradle` in your repository. [example](https://github.com/opensearch-project/sql/blob/opensearch-1.0.0.0-rc1/build.gradle#L48)
2. Set Jacoco to export coverage report in `xml` format. [example](https://github.com/opensearch-project/sql/blob/opensearch-1.0.0.0-rc1/build.gradle#L101-L105)
3. Call gradle task "jacocoTestReport" to generate report (`./gradlew jacocoTestReport`) after running your tests. (Or add a `dependsOn` to make "jacocoTestReport" task depending on your test tasks. [example](https://github.com/opensearch-project/index-management/blob/opensearch-1.0.0.0-beta1/build-tools/coverage.gradle))

##### Maven project
Since OpenSearch uses Gradle as the build tool, we don't recommend using Maven.
Code coverage for a Maven project can be generated by [JaCoCo Maven plugin](https://www.eclemma.org/jacoco/trunk/doc/maven.html), and we also got an [example](https://github.com/opensearch-project/security/blob/v1.0.0.0-rc1/pom.xml#L636).

#### OpenSearch Dashboards plugin

#### Limitation

### Code Coverage Reporting
OpenSearch plugins are using [Codecov](https://about.codecov.io/) for code coverage reporting and analysis. The dashboard can be seen [here](https://app.codecov.io/gh/opensearch-project/).

All the OpenSearch plugins are required to have the following items:

#### Code coverage report upload through CI workflow
1. Generate code coverage report in `xml` format in a CI workflow of Github Actions
2. Upload the report to Codecov by adding a step of [codecov-action](https://github.com/codecov/codecov-action) in the workflow.
3. For private repositories, an upload token is needed, visit the repository page of Codecov to get your token: https://codecov.io/gh/opensearch-project/REPO-NAME-HERE. Please follow [Github docs](https://docs.github.com/en/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository) to use Github Secrets to store the token and not expose to the public.
4. Set the workflow to be triggered by `push` and `pull request` on `main` and release branches.
5. To see your code coverage results from Codecov, visiting https://codecov.io/gh/opensearch-project/REPO-NAME-HERE after the CI workflow is triggered.

See [CI Workflows](STANDARDS.md#ci-workflows) for example.

#### A status badge in README file of the repository to show the code coverage.  ([example](https://github.com/opensearch-project/index-management#readme))
Add the following line at the header of the README markdown file:
```
[![codecov](https://codecov.io/gh/opensearch-project/REPO-NAME-HERE/branch/main/graph/badge.svg)](https://codecov.io/gh/opensearch-project/REPO-NAME-HERE)
```
Link of the badge can also be accessed from the repository's settings page of Codecov: 
https://app.codecov.io/gh/opensearch-project/REPO-NAME-HERE/settings/badge

#### Codecov integration in Pull Requests
1. Add a `codecov.yml` file into the repository ([example](https://github.com/opensearch-project/k-NN/commit/f7d1985230ce851cb97a7e41d8bce32127a4f33b))
2. Set the target code coverage properly in case it blocks your PR in Github checks.

See Codecov docs to learn more about [codecov yaml file](https://docs.codecov.com/docs/codecov-yaml) and [common configurations](https://docs.codecov.com/docs/common-recipe-list).